---
const {
  brand = "MOODIGITAL",
  nav = [
    { label: "Offres", href: "#offres" },
    { label: "Process", href: "#process" },
    { label: "FAQ", href: "#faq" },
  ],
  ctaLabel = "Reserver une demo",
  ctaHref = "#",
} = Astro.props;

const ICON_HAMBURGER = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" focusable="false">
  <path fill="currentColor" d="M1 8h30a1 1 0 0 0 0-2H1a1 1 0 0 0 0 2zM31 15H1a1 1 0 0 0 0 2h30a1 1 0 0 0 0-2zM31 24H1a1 1 0 0 0 0 2h30a1 1 0 0 0 0-2z"></path>
</svg>`;

const ICON_CROSS = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" aria-hidden="true" focusable="false">
  <path fill="currentColor" d="m53.657 48 25.171-25.172a4 4 0 1 0-5.656-5.656L48 42.343 22.829 17.172a4 4 0 0 0-5.657 5.656L42.344 48 17.172 73.172a4 4 0 1 0 5.657 5.656L48 53.657l25.172 25.171C73.953 79.609 74.977 80 76 80s2.048-.391 2.828-1.172a4 4 0 0 0 0-5.656L53.657 48z"></path>
</svg>`;
---

<header class="siteHeader" data-header>
  <div class="shell">
    <div class="pill" data-pill>
      <a class="brand" href="#top" aria-label="Aller en haut">
        <span class="dot" aria-hidden="true"></span>
        <span class="brandText">{brand}</span>
      </a>

      <nav class="nav desktop" aria-label="Navigation principale">
        {nav.map((item) => (
          <a class="navLink" href={item.href}>{item.label}</a>
        ))}
      </nav>

      <div class="right desktop">
        <a class="cta" href={ctaHref} target={ctaHref?.startsWith("http") ? "_blank" : undefined} rel={ctaHref?.startsWith("http") ? "noreferrer" : undefined}>
          <span>{ctaLabel}</span>
          <span class="ctaArrow" aria-hidden="true">→</span>
        </a>
      </div>

      <button class="menuBtn mobile" type="button" aria-expanded="false" aria-controls="mobilePanel" data-menu-btn>
        <span class="srOnly">Menu</span>
        <span class="icon" data-icon set:html={ICON_HAMBURGER}></span>
      </button>

      <div id="mobilePanel" class="mobilePanel" data-panel aria-hidden="true">
        <nav class="nav mobileNav" aria-label="Navigation mobile">
          {nav.map((item) => (
            <a class="mobileItem" href={item.href} data-close>
              <span>{item.label}</span>
              <span class="chev" aria-hidden="true">→</span>
            </a>
          ))}
        </nav>

        <a class="cta mobileCta" href={ctaHref} data-close target={ctaHref?.startsWith("http") ? "_blank" : undefined} rel={ctaHref?.startsWith("http") ? "noreferrer" : undefined}>
          <span>{ctaLabel}</span>
          <span class="ctaArrow" aria-hidden="true">→</span>
        </a>
      </div>
    </div>
  </div>

  <div class="overlay" data-overlay aria-hidden="true"></div>
</header>

<script>
  const header = document.querySelector("[data-header]");
  const pill = document.querySelector("[data-pill]");
  const btn = document.querySelector("[data-menu-btn]");
  const panel = document.querySelector("[data-panel]");
  const overlay = document.querySelector("[data-overlay]");
  const icon = document.querySelector("[data-icon]");

  if (!header || !pill || !btn || !panel || !overlay || !icon) {}

  const ICON_HAMBURGER = `<?xml version="1.0" encoding="UTF-8"?>${String.raw`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" focusable="false">
    <path fill="currentColor" d="M1 8h30a1 1 0 0 0 0-2H1a1 1 0 0 0 0 2zM31 15H1a1 1 0 0 0 0 2h30a1 1 0 0 0 0-2zM31 24H1a1 1 0 0 0 0 2h30a1 1 0 0 0 0-2z"></path>
  </svg>`}`;

  const ICON_CROSS = `<?xml version="1.0" encoding="UTF-8"?>${String.raw`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" aria-hidden="true" focusable="false">
    <path fill="currentColor" d="m53.657 48 25.171-25.172a4 4 0 1 0-5.656-5.656L48 42.343 22.829 17.172a4 4 0 0 0-5.657 5.656L42.344 48 17.172 73.172a4 4 0 1 0 5.657 5.656L48 53.657l25.172 25.171C73.953 79.609 74.977 80 76 80s2.048-.391 2.828-1.172a4 4 0 0 0 0-5.656L53.657 48z"></path>
  </svg>`}`;

  const setScrolled = () => {
    const scrolled = window.scrollY > 8;
    header?.toggleAttribute("data-scrolled", scrolled);
  };

  let raf = 0;
  const onScroll = () => {
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(setScrolled);
  };

  const openMenu = () => {
    pill?.classList.add("isOpen");
    btn?.setAttribute("aria-expanded", "true");
    panel?.setAttribute("aria-hidden", "false");
    overlay?.setAttribute("aria-hidden", "false");
    icon && (icon.innerHTML = ICON_CROSS);
    document.documentElement.setAttribute("data-menu-open", "true");
  };

  const closeMenu = () => {
    pill?.classList.remove("isOpen");
    btn?.setAttribute("aria-expanded", "false");
    panel?.setAttribute("aria-hidden", "true");
    overlay?.setAttribute("aria-hidden", "true");
    icon && (icon.innerHTML = ICON_HAMBURGER);
    document.documentElement.removeAttribute("data-menu-open");
  };

  const toggleMenu = () => {
    const isOpen = pill?.classList.contains("isOpen");
    if (isOpen) closeMenu();
    else openMenu();
  };

  setScrolled();
  window.addEventListener("scroll", onScroll, { passive: true });

  btn?.addEventListener("click", toggleMenu);
  overlay?.addEventListener("click", closeMenu);

  panel?.addEventListener("click", (e) => {
    const a = e.target.closest("[data-close]");
    if (a) closeMenu();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMenu();
  });

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 900) closeMenu();
  });
</script>

<style>
  :global(html[data-menu-open="true"]) { overflow: hidden; }

  .siteHeader{
    position: fixed;
    left: 0; right: 0;
    top: 12px;
    z-index: 60;
    pointer-events: none;
  }

  .shell{
    width: min(1120px, calc(100% - 24px));
    margin: 0 auto;
    pointer-events: none;
  }

  .pill{
    pointer-events: auto;
    position: relative;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 16px;
    padding: 12px 14px;
    border-radius: 999px;
    background: rgba(0,0,0,0);
    border: 1px solid rgba(255,255,255,0);
    transition: background .22s ease, border-color .22s ease, box-shadow .22s ease, padding .22s ease;
  }

  .siteHeader[data-scrolled] .pill,
  .pill.isOpen{
    background: rgba(10,10,10,.62);
    border-color: rgba(255,255,255,.10);
    box-shadow: 0 18px 70px rgba(0,0,0,.45);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .brand{
    display: inline-flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: rgba(255,255,255,.92);
    font-weight: 700;
    letter-spacing: .22em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .dot{
    width: 10px; height: 10px;
    border-radius: 50%;
    background: rgb(220,140,60);
    box-shadow: 0 0 0 6px rgba(220,140,60,.16);
  }

  .nav{
    display: flex;
    justify-content: center;
    gap: 26px;
  }

  .navLink{
    color: rgba(255,255,255,.78);
    text-decoration: none;
    font-weight: 600;
    letter-spacing: .01em;
    padding: 10px 6px;
    border-radius: 10px;
    transition: color .18s ease, opacity .18s ease;
  }
  .navLink:hover{ color: rgba(255,255,255,.92); }

  .right{
    display: flex;
    justify-content: flex-end;
  }

  .cta{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: 999px;
    text-decoration: none;
    font-weight: 700;
    color: rgba(15,15,15,.95);
    background: rgba(236,228,214,.95);
    border: 1px solid rgba(236,228,214,.22);
    box-shadow: 0 16px 60px rgba(0,0,0,.35);
    transition: transform .18s ease, box-shadow .18s ease;
    white-space: nowrap;
  }
  .cta:hover{ transform: translateY(-1px); box-shadow: 0 24px 80px rgba(0,0,0,.45); }
  .ctaArrow{ transform: translateY(-1px); }

  .srOnly{
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    border: 0;
  }

  .menuBtn{
    justify-self: end;
    width: 44px; height: 44px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(10,10,10,.55);
    color: rgba(255,255,255,.92);
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: transform .18s ease, border-color .18s ease, background .18s ease;
  }
  .menuBtn:hover{ transform: translateY(-1px); border-color: rgba(220,140,60,.30); }

  .icon :global(svg){ width: 20px; height: 20px; }

  /* Mobile panel: c'est le header qui s'etend */
  .mobilePanel{
    grid-column: 1 / -1;
    margin-top: 10px;
    border-radius: 22px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(10,10,10,.72);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    overflow: hidden;

    max-height: 0;
    opacity: 0;
    transform: translateY(-6px);
    pointer-events: none;
    transition: max-height .34s ease, opacity .22s ease, transform .22s ease;
  }

  .pill.isOpen .mobilePanel{
    max-height: 420px;
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .mobileNav{
    display: grid;
    gap: 10px;
    padding: 14px;
  }

  .mobileItem{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 14px;
    border-radius: 16px;
    text-decoration: none;
    color: rgba(255,255,255,.90);
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.22);
    transition: border-color .18s ease, transform .18s ease;
  }
  .mobileItem:hover{ transform: translateY(-1px); border-color: rgba(220,140,60,.26); }

  .mobileCta{
    margin: 0 14px 14px;
    width: calc(100% - 28px);
    justify-content: center;
  }

  .overlay{
    position: fixed;
    inset: 0;
    z-index: 40;
    background: rgba(0,0,0,.55);
    opacity: 0;
    pointer-events: none;
    transition: opacity .22s ease;
  }

  :global(html[data-menu-open="true"]) .overlay{
    opacity: 1;
    pointer-events: auto;
  }

  /* Responsive */
  .mobile{ display: none; }
  .desktop{ display: flex; }

  @media (max-width: 899px){
    .pill{ grid-template-columns: 1fr auto; }
    .desktop{ display: none; }
    .mobile{ display: grid; }
    .nav{ justify-content: flex-start; }
  }

  @media (prefers-reduced-motion: reduce){
    .pill, .cta, .menuBtn, .mobilePanel, .overlay{ transition: none; }
  }
</style>
